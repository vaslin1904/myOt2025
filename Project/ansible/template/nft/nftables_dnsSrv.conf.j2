#!/usr/sbin/nft -f
flush ruleset

table inet filter {
    chain input {
        type filter hook input priority 0; policy drop;

        # Разрешаем loopback
        iif "lo" accept

        # Установленные соединения
        ct state established,related accept

        # ICMP (ping) и OSPF
        ip protocol icmp accept
        ip protocol ospf accept

        iifname "enp0s19" oifname "enp0s8" accept
        iifname "enp0s8" oifname "enp0s19" accept
        ### SSH
        # Vagrant ssh (через NAT port forwarding)
        iifname "enp0s3" tcp dport 22 accept

        # Хост → dnsSrv (host-only)
        iifname "enp0s19" ip saddr 192.168.56.1 tcp dport 22 accept

        # DMZ → dnsSrv
        iifname "enp0s8" ip saddr 10.10.1.0/24 tcp dport 22 accept

        ### DNS
        # DNS (UDP и TCP) — из host-only и DMZ
        iifname { "enp0s19", "enp0s8" } \
          ip saddr { 192.168.56.0/24, 10.10.1.0/24 } udp dport 53 limit rate 20/second burst 30 packets accept
        iifname { "enp0s19", "enp0s8" } \
          ip saddr { 192.168.56.0/24, 10.10.1.0/24 } tcp dport 53 accept

        ### Веб-сервер (HTTP/HTTPS)
        # Только с хоста
        iifname "enp0s19" ip saddr 192.168.56.1 tcp dport { 80, 443 } accept

        ### Мониторинг
        # Node Exporter и Prometheus
        iifname "enp0s8" ip saddr 10.10.1.0/24 tcp dport { 9100, 9090 } accept
        iifname "enp0s19" ip saddr 192.168.56.90 tcp dport { 9100, 9090 } accept

        # SNMP Exporter
        iifname "enp0s8" ip saddr 10.10.1.0/24 tcp dport 9116 accept
        iifname "enp0s19" ip saddr 192.168.56.90 tcp dport 9116 accept

        # Grafana
        iifname "enp0s19" ip saddr 192.168.56.1 tcp dport 3000 accept

        ### MySQL
        # Только из DMZ
        iifname "enp0s8" ip saddr 10.10.1.0/24 tcp dport 3306 accept
    }

    chain forward {
        type filter hook forward priority 0; policy drop;

        # NAT: DMZ → интернет
        ip saddr 10.10.1.0/24 oifname "enp0s3" accept
        ip saddr 10.10.1.0/24 oifname "enp0s19" accept

        # Транзитный трафик: enp0s19 → enp0s8
        iifname "enp0s19" oifname "enp0s8" ip daddr { 10.10.1.31, 10.10.1.32, 10.10.1.51, 10.10.1.52 } tcp dport { 22, 80, 443, 3306, 9100, 9116, 9090 } accept

        # Jump: хост → web/Grafana (через Angie или напрямую)
        iifname "enp0s19" ip saddr 192.168.56.1 oifname "enp0s8" ip daddr { 10.10.1.31, 10.10.1.32 } tcp dport { 80, 443 } accept
        iifname "enp0s19" ip saddr 192.168.56.1 oifname "enp0s8" ip daddr { 10.10.1.31, 10.10.1.32, 10.10.1.51, 10.10.1.52 } tcp dport 22 accept

        # Обратный трафик
        ct state established,related accept
    }

    chain output {
        type filter hook output priority 0; policy accept;
    }
}

table ip nat {
    chain prerouting {
        type nat hook prerouting priority 0; policy accept;

        # Перенаправление HTTP/HTTPS-трафика для linuxpro -> dnsSrv (10.10.1.10)
        iifname "enp0s19" ip saddr 192.168.56.1 tcp dport { 80, 443 } dnat to 10.10.1.10

        # Round Robin для my.linuxpro -> web1/web2
        iifname "enp0s19" ip saddr 192.168.56.1 tcp dport { 80, 443 } dnat to numgen inc mod 2 map { 0 : 10.10.1.31, 1 : 10.10.1.32 }
    }

    chain postrouting {
        type nat hook postrouting priority 100; policy accept;

        # NAT для DMZ → интернет
        ip saddr 10.10.1.0/24 oifname "enp0s3" masquerade
        ip saddr 10.10.1.0/24 oifname "enp0s19" accept
    }
}
